var DirectionEnum={North:"north",East:"east",South:"south",West:"west",Corner:"corner",Stop:"stop"};Object.freeze(DirectionEnum);function DirectionMap(){this.dirMap={};this.nbrhdToDir=function(t){if(!t)return DirectionEnum.Stop;var r=this.dirMap[t];return r};this.init=function(){this.addDirMapEntry(0,1,1,1,1,1,1,1,1,DirectionEnum.North);this.addDirMapEntry(1,0,1,1,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,0,1,1,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,0,1,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,1,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,1,1,1,0,1,1,1,DirectionEnum.South);this.addDirMapEntry(1,1,0,0,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,1,0,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,1,1,1,0,1,1,1,DirectionEnum.South);this.addDirMapEntry(0,1,1,1,1,1,1,1,0,DirectionEnum.Corner);this.addDirMapEntry(0,1,1,1,1,1,1,0,1,DirectionEnum.North);this.addDirMapEntry(1,1,0,1,1,1,1,0,1,DirectionEnum.West);this.addDirMapEntry(1,0,1,1,1,1,1,1,0,DirectionEnum.South);this.addDirMapEntry(1,0,1,1,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,0,1,0,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,0,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,1,1,0,1,1,1,DirectionEnum.South);this.addDirMapEntry(0,1,0,1,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,1,1,1,1,1,0,DirectionEnum.South);this.addDirMapEntry(1,1,0,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,1,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(1,0,1,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,1,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(0,1,1,0,1,1,0,1,1,DirectionEnum.North);this.addDirMapEntry(0,0,1,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,0,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(0,1,0,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(0,0,1,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(1,0,0,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,0,0,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(2,0,0,2,1,1,2,1,1,DirectionEnum.East);this.addDirMapEntry(2,0,1,2,1,1,2,1,1,DirectionEnum.East);this.addDirMapEntry(2,1,0,2,1,1,2,1,1,DirectionEnum.East);this.addDirMapEntry(0,0,2,1,1,2,1,1,2,DirectionEnum.Stop);this.addDirMapEntry(1,0,2,1,1,2,1,1,2,DirectionEnum.Stop);this.addDirMapEntry(0,0,2,1,1,2,1,0,2,DirectionEnum.Stop);this.addDirMapEntry(0,1,2,1,1,2,1,1,2,DirectionEnum.Stop);this.addDirMapEntry(0,1,2,1,1,2,1,0,2,DirectionEnum.Stop)};this.RotDir90=function(t){if(t===DirectionEnum.East)return DirectionEnum.South;if(t===DirectionEnum.South)return DirectionEnum.West;if(t===DirectionEnum.West)return DirectionEnum.North;if(t===DirectionEnum.North)return DirectionEnum.East;return t};this.RotDir180=function(t){if(t===DirectionEnum.East)return DirectionEnum.West;if(t===DirectionEnum.South)return DirectionEnum.North;if(t===DirectionEnum.West)return DirectionEnum.East;if(t===DirectionEnum.North)return DirectionEnum.South;return t};this.RotDir270=function(t){if(t===DirectionEnum.East)return DirectionEnum.North;if(t===DirectionEnum.South)return DirectionEnum.East;if(t===DirectionEnum.West)return DirectionEnum.South;if(t===DirectionEnum.North)return DirectionEnum.West;return t};this.encodeNbrhdRot90=function(t,r,e,i,a,n,o,h,s){return(o<<0)+(i<<2)+(t<<4)+(h<<6)+(a<<8)+(r<<10)+(s<<12)+(n<<14)+(e<<16)};this.encodeNbrhdRot180=function(t,r,e,i,a,n,o,h,s){return(s<<0)+(h<<2)+(o<<4)+(n<<6)+(a<<8)+(i<<10)+(e<<12)+(r<<14)+(t<<16)};this.encodeNbrhdRot270=function(t,r,e,i,a,n,o,h,s){return(e<<0)+(n<<2)+(s<<4)+(r<<6)+(a<<8)+(h<<10)+(t<<12)+(i<<14)+(o<<16)};this.addDirMapEntry=function(t,r,e,i,a,n,o,h,s,c){this.dirMap[DirectionMap.encodeNbrhd(t,r,e,i,a,n,o,h,s)]=c;this.dirMap[this.encodeNbrhdRot90(t,r,e,i,a,n,o,h,s)]=this.RotDir90(c);this.dirMap[this.encodeNbrhdRot180(t,r,e,i,a,n,o,h,s)]=this.RotDir180(c);this.dirMap[this.encodeNbrhdRot270(t,r,e,i,a,n,o,h,s)]=this.RotDir270(c)};this.init()}DirectionMap.encodeNbrhd=function(t,r,e,i,a,n,o,h,s){en1=t<<0;en2=r<<2;en3=e<<4;en4=i<<6;en5=a<<8;en6=n<<10;en7=o<<12;en8=h<<14;en9=s<<16;return en1+en2+en3+en4+en5+en6+en7+en8+en9};function Matrix2(t,r,e,i){this.vals=[[t,r],[e,i]]}Matrix2.prototype.multiplyVec=function(t){var r={};r.x=t.x*this.vals[0][0]+t.y*this.vals[0][1];r.y=t.x*this.vals[1][0]+t.y*this.vals[1][1];return r};function AcGrey8Image(t,r){AcGreyImage.call(this,t,r);this.databuffer=new ArrayBuffer(t*r);this.data=new Uint8ClampedArray(this.databuffer)}AcGrey8Image.prototype=Object.create(AcGreyImage.prototype);AcGrey8Image.prototype.constructor=AcGreyImage;AcGrey8Image.prototype.copy=function(){var t=new AcGrey8Image(this.width,this.height);t.data.set(this.data);return t};function AcGrey16Image(t,r){AcGreyImage.call(this,t,r);this.databuffer=new ArrayBuffer(t*r*2);this.data=new Uint16Array(this.databuffer)}AcGrey16Image.prototype=Object.create(AcGreyImage.prototype);AcGrey16Image.prototype.constructor=AcGreyImage;AcGrey16Image.prototype.copy=function(){var t=new AcGrey16Image(this.width,this.height);t.data.set(this.data);return t};function AcGreyImage(t,r){this.width=t;this.height=r}AcGreyImage.prototype.getAt=function(t,r){return this.data[this.width*r+t]};AcGreyImage.prototype.setAt=function(t,r,e){this.data[this.width*r+t]=e};AcGreyImage.prototype.copy=function(t){throw new Error("not implemented - needs to be overridden in subclass")};AcGreyImage.prototype.getNbrhd=function(t,r){var e={};if(t>0&&r>0&&t<this.width-1&&r<this.height-1){e.nw=this.getAt(t-1,r-1);e.nn=this.getAt(t,r-1);e.ne=this.getAt(t+1,r-1);e.ww=this.getAt(t-1,r);e.cc=this.getAt(t,r);e.ee=this.getAt(t+1,r);e.sw=this.getAt(t-1,r+1);e.ss=this.getAt(t,r+1);e.se=this.getAt(t+1,r+1)}return e};AcGreyImage.prototype.getEncodedNbrhd=function(t,r){var e=this.getNbrhd(t,r);return DirectionMap.encodeNbrhd(e.nw,e.nn,e.ne,e.ww,e.cc,e.ee,e.sw,e.ss,e.se)};AcGreyImage.prototype.thresholdImage=function(t){var r,e;for(r=0;r<this.width;++r){for(e=0;e<this.height;++e){this.setAt(r,e,this.getAt(r,e)<=t?1:0)}}};AcGreyImage.prototype.debugPrint=function(){console.log("Width, Height: "+this.width+", "+this.height);var t="";var r="000";for(var e=0;e<this.height;++e){for(var i=0;i<this.width;++i){var a=this.getAt(i,e);var n=(r+a.toString()).slice(-r.length);t=t+n+" "}t=t+"\n"}console.log(t)};AcGreyImage.prototype.initFromCanvas=function(t){var r=t.getContext("2d");this.width=t.width;this.height=t.height;var e=r.getImageData(0,0,this.width,this.height);var i=e.data;var a=new Uint8ClampedArray(e.data);var n=new Uint32Array(e.data);this.databuffer=new ArrayBuffer(e.data.length/4);this.data=new Uint8ClampedArray(this.databuffer);n[1]=168496141;var o=true;if(i[4]===10&&i[5]===11&&i[6]===12&&i[7]===13){o=false}for(var h=0;h<this.height;++h){for(var s=0;s<this.width;++s){var c=(h*t.width+s)*4;var u=o?n[c]:n[c+3];var d=o?n[c+1]:n[c+2];var v=o?n[c+2]:n[c+1];var y=o?n[c+3]:n[c];var f=.2126*u+.7152*d+.0722*v;this.data[h*this.width+s]=f}}};AcGreyImage.prototype.draw=function(t,r,e){var i=t.width;var a=t.height;var n=t.getContext("2d");var o=n.getImageData(0,0,i,a);var h=new ArrayBuffer(o.data.length);var s=new Uint8ClampedArray(h);var c=new Uint32Array(h);c[1]=168496141;var u=true;if(h[4]===10&&h[5]===11&&h[6]===12&&h[7]===13){u=false}for(var d=0;d<this.height;++d){for(var v=0;v<this.width;++v){var y=this.getAt(v,d);c[d*i+v]=this.encodeHeight(y,u)}}o.data.set(s);n.putImageData(o,0,0)};AcGreyImage.prototype.convolve3x3=function(t,r){for(var e=1;e<this.height;++e){for(var i=1;i<this.width;++i){var a=t.getNbrhd(i,e);var n=r(a);this.setAt(i,e,n)}}};AcGrey8Image.prototype.encodeHeight=function(t,r){if(r){return 255<<24|t<<16|t<<8|t}else{return t<<24|t<<16|t<<8|255}};AcGrey16Image.prototype.encodeHeight=function(t,r){if(r){if(t>2550)t=2550;return 255<<24|t/10<<16|t/10<<8|t/10}else{return t/255<<24|t/255<<16|t/255<<8|255}};circToPtsErr=function(t,r){var e=0;for(var i=0;i<t.length;++i){var a=distPtCirc(t[i],r);if(a>e)e=a}return e};reduceInterval=function(t,r,e,i,a){var n={min:r,max:a};var o=makeCircleBy3Pts(t[0],{x:0,y:e},t[t.length-1]);var h=makeCircleBy3Pts(t[0],{x:0,y:i},t[t.length-1]);var s=circToPtsErr(t,o);var c=circToPtsErr(t,h);var u=1e-4;if(Math.abs(s-c)<u){n.min=e;n.max=i;return n}if(s<c){n.max=i;return n}if(s>c){n.min=e;return n}};findMminMmax=function(t){if(t.length<3)alert("less than 3 pts in findMminMmax");var r=t.length-1;var e=t[0];var i=t[r];var a,n,o;var h;var s=true;var c=makePerpBisectLine(e,i);a=Number.MAX_VALUE;o=Number.MIN_VALUE;for(var u=1;u<r;++u){if(collinear(e,t[u],i))continue;s=false;h=makeCircleBy3Pts(e,t[u],i);n=h.center.y+h.radius;if(n<a)a=n;if(n>o)o=n}if(s){alert("all collinear?");a=o=0}return{min:a,max:o}};_findBestArcYVal=function(t,r){var e=findMminMmax(t);var i,a;var n=e.max-e.min;while(n>r){i=n/3+e.min;a=2*n/3+e.min;e=reduceInterval(t,e.min,i,a,e.max);n=e.max-e.min}var o=(e.max+e.min)/2;return o};findBestCircleFit=function(t,r){var e=t.slice(0);var i=t[0];var a=t.length-1;var n=t[a];var o=n.y-i.y;var h=n.x-i.x;var s=distPtPt(i,n);var c=o/s;var u=h/s;var d=new Matrix2(u,c,-c,u);var v=new Matrix2(u,-c,c,u);for(var y=0;y<t.length;++y){e[y]=d.multiplyVec(t[y])}var f=makeMidPt(e[0],e[a]);for(var y=0;y<t.length;++y){e[y].x=e[y].x-f.x;e[y].y=e[y].y-f.y}var l=_findBestArcYVal(e,r);var m=makeCircleBy3Pts(e[0],{x:0,y:l},e[a]);m.center.x=m.center.x+f.x;m.center.y=m.center.y+f.y;var p={x:0+f.x,y:l+f.y};m.center=v.multiplyVec(m.center);p=v.multiplyVec(p);return{circle:m,arcpts:[t[0],p,t[a]]}};function Sep(t,r,e,i){"use strict";return Math.floor((i*i-e*e+t.getAt(i,r)*t.getAt(i,r)-t.getAt(e,r)*t.getAt(e,r))/(2*(i-e)))}function EDT_f(t,r,e,i){"use strict";return(e-i)*(e-i)+t.getAt(i,r)*t.getAt(i,r)}function computeDistTrans(t,r){"use strict";var e,i,a,n,o,h,s,c,u,d,v;e=new AcGrey16Image(t.width,t.height);i=t.width;a=t.height;n=i+a;for(o=0;o<i;o+=1){e.data[o]=t.getAt(o,0)===0?0:n;for(h=1;h<a;h+=1){e.data[h*e.width+o]=t.getAt(o,h)===0?0:1+e.getAt(o,h-1)}for(h=a-1;h>=0;h-=1){if(e.getAt(o,h+1)<e.getAt(o,h)){e.data[h*e.width+o]=1+e.getAt(o,h+1)}}}for(h=0;h<a;++h){s=0;c=[];u=[];c[0]=0;u[0]=0;for(d=1;d<i;++d){while(s>=0&&EDT_f(e,h,u[s],c[s])>EDT_f(e,h,u[s],d)){--s}if(s<0){s=0;c[0]=d}else{v=1+Sep(e,h,c[s],d);if(v<i){++s;c[s]=d;u[s]=v}}}for(d=i;d>=0;--d){r.data[h*r.width+d]=EDT_f(e,h,d,c[s]);if(d===u[s]){--s}}}}var drawCutouts=function(t,r,e){var i=t.getContext("2d");i.save();i.fillStyle="white";i.fillRect(0,0,t.width,t.height);i.restore();i.save();i.fillStyle="#000000";r.bottom.draw(t,e.bottom.x,e.bottom.y);r.front.draw(t,e.front.x,e.front.y);r.back.draw(t,e.back.x,e.back.y);r.left.draw(t,e.left.x,e.left.y);r.right.draw(t,e.right.x,e.right.y);i.restore()};var buildCutouts=function(t,r,e,i,a,n){t.bottom=new Cutout(r.length,r.width,r.matThick,null,e,i,a,n);t.front=new Cutout(r.length,r.height,r.matThick,true,e,i,a,n);t.back=new Cutout(r.length,r.height,r.matThick,true,e,i,a,n);t.left=new Cutout(r.height,r.width,r.matThick,false,e,i,a,n);t.right=new Cutout(r.height,r.width,r.matThick,false,e,i,a,n)};var buildLayout=function(t,r,e,i){var a=30;var n=e*1.1*i;var o=r.height*i;var h=r.width*i;var s=r.length*i;t.bottom={};t.bottom.x=o+3*n+a;t.bottom.y=o+3*n+a;t.front={};t.front.x=n+a;t.front.y=o+3*n+a;t.back={};t.back.x=o+h+5*n+a;t.back.y=o+3*n+a;t.left={};t.left.x=o+3*n+a;t.left.y=n+a;t.right={};t.right.x=o+3*n+a;t.right.y=o+s+5*n+a};var distPtPt=function(t,r){return Math.sqrt((r.x-t.x)*(r.x-t.x)+(r.y-t.y)*(r.y-t.y))};var distPointLineseg=function(t,r){var e=makeLineBy2Pts(r.p0,r.p1);var i=distPointLine(t,e);var a=distPtPt(t,r.p0);var n=distPtPt(t,r.p1);return Math.min(i,a,n)};var distPointLine=function(t,r){var e=Math.abs(r.a*t.x+r.b*t.y+r.c);var i=Math.sqrt(r.a*r.a+r.b*r.b);var a=e/i;return a};var makeLineBy2Pts=function(t,r){var e=t.y-r.y;var i=r.x-t.x;var a=t.x*r.y-r.x*t.y;return{a:e,b:i,c:a}};var makeMidPt=function(t,r){return{x:(t.x+r.x)/2,y:(t.y+r.y)/2}};var collinear=function(t,r,e,i){if(!i)i=.001;var a={};var n={};a.x=r.x-t.x;a.y=r.y-t.y;n.x=e.x-t.x;n.y=e.y-t.y;var o=a.x*n.y-n.x*a.y;return Math.abs(o)<i};var makePerpBisectLine=function(t,r){var e=makeMidPt(t,r);var i={x:e.y+e.x-r.y,y:r.x+e.y-e.x};return makeLineBy2Pts(e,i)};var makeCircleBy3Pts=function(t,r,e){var i=2*(t.x*(r.y-e.y)+r.x*(e.y-t.y)+e.x*(t.y-r.y));var a=((t.x*t.x+t.y*t.y)*(r.y-e.y)+(r.x*r.x+r.y*r.y)*(e.y-t.y)+(e.x*e.x+e.y*e.y)*(t.y-r.y))/i;var n=((t.x*t.x+t.y*t.y)*(e.x-r.x)+(r.x*r.x+r.y*r.y)*(t.x-e.x)+(e.x*e.x+e.y*e.y)*(r.x-t.x))/i;var o=(r.x-t.x)*(r.x-t.x)+(r.y-t.y)*(r.y-t.y);var h=(r.x-e.x)*(r.x-e.x)+(r.y-e.y)*(r.y-e.y);var s=(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y);var c=2*Math.sqrt(o*h*s);var u=Math.sqrt(o);var d=Math.sqrt(h);var v=Math.sqrt(s);var y=(u+d+v)*(-u+d+v)*(u-d+v)*(u+d-v);var f=Math.sqrt(y);var l=c/f;return{center:{x:a,y:n},radius:l/2}};var distPtCirc=function(t,r){var e=r.center;var i=(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y);var a=Math.sqrt(i);return Math.abs(a-r.radius)};var intersectLineCircle=function(t,r,e){var i=1e-6;if(distPtPt(t,r)<i||e.radius<i){return false}var a=e.center.x;var n=e.center.y;var o=e.radius;var h=Math.pow(r.x-t.x,2)+Math.pow(r.y-t.y,2);var s=2*(r.x-t.x)*(t.x-a)+2*(r.y-t.y)*(t.y-n);var e=Math.pow(t.x-a,2)+Math.pow(t.y-n,2)-Math.pow(o,2);var c=s*s-4*h*e;if(c<0){return false}var u=Math.sqrt(c);var d=(-s+u)/(2*h);var v=(-s-u)/(2*h);var y=(r.x-t.x)*d+t.x;var f=(r.y-t.y)*d+t.y;var l=(r.x-t.x)*v+t.x;var m=(r.y-t.y)*v+t.y;return[{x:y,y:f},{x:l,y:m}]};var DouglasPeuckerCircs=function(t,r){if(t.length<3)return[];var e=0;var i=0;var a=0;var n=0;var o=0;var h=0;var s=findBestCircleFit(t,r);var c=s.circle;var u=t.length-1;var d=[];for(var v=0;v<=u;++v){var y=distPtCirc(t[v],c);if(y>e){i=v;e=y}}if(e>r){var f=DouglasPeuckerCircs(t.slice(0,i),r);var l=DouglasPeuckerCircs(t.slice(i,u),r);d=f;d=d.concat(l)}else{d.push(t[0]);d.push({x:s.arcpts[1].x,y:s.arcpts[1].y,cx:s.circle.center.x,cy:s.circle.center.y,radius:s.circle.radius})}return d};var RamerDouglasPeucker=function(t,r){var e=0;var i=0;var a=0;var n=0;var o=0;var h=0;var s=false;var c=t.length-1;var u=[];for(var d=0;d<=c;++d){var v=distPointLineseg(t[d],{p0:t[0],p1:t[c]});if(v>e){i=d;e=v}if(s){var y=makeCircle(t[0],t[Math.floor(c/2)],t[c]);var a=distancePtCircle(t[d],y);if(a>n){o=d;n=a;h=y.radius}}}if(s){if(n<r*2&&e>r){var f=t[Math.floor(c/2)];u.push(t[0]);u.push({circleRad:h,x:f.x,y:f.y});u.push(t[c]);return u}}if(e>r){var l=RamerDouglasPeucker(t.slice(0,i),r);var m=RamerDouglasPeucker(t.slice(i,c),r);u=l;u=u.concat(m)}else{u.push(t[0]);u.push(t[c])}return u};function Path(){this.ptdirs=[];this.pathSegments=[];this.pathSimpleSegs=[];this.pathArcSegs=[];this.meshes=[];this.scaleSimpleSegs=function(t){for(var r=0;r<this.pathSimpleSegs.length;++r){var e=this.pathSimpleSegs[r];for(var i=0;i<e.length;++i){e[i].x*=t;e[i].y*=t}}};this.buildThreeShape=function(t){var r=new THREE.Shape;var e=t[0];var i=t[t.length-1];var a;r.moveTo(e.x,e.y);for(a=1;a<t.length;++a){r.lineTo(t[a].x,t[a].y)}r.lineTo(i.x,i.y);return r};this.addSimpleSegsAsMeshes=function(t){var r;for(r=0;r<this.pathSimpleSegs.length;++r){var e=this.buildThreeShape(this.pathSimpleSegs[r]);var i={amount:t};i.bevelEnabled=false;i.steps=1;var a=addShape(e,i,12555117,-150,300,0,Math.PI,0,0,1);this.meshes.push(a)}};this.addSimpleSegsToScene=function(){var t;for(t=0;t<this.pathSimpleSegs.length;++t){var r=this.buildThreeShape(this.pathSimpleSegs[t]);addLine(r,0,-150,300,0,Math.PI,0,0,1)}};this.buildSimpleSegs=function(t){var r,e;for(r=0;r<this.pathSegments.length;++r){e=RamerDouglasPeucker(this.pathSegments[r],t);this.pathSimpleSegs.push(e)}};this.buildArcInterp=function(t){var r,e;for(r=0;r<this.pathSegments.length;++r){e=DouglasPeuckerCircs(this.pathSegments[r],t);this.pathArcSegs.push(e)}};var t=function(t,r,e){var i=t.x/(25.4*e);var a=t.y/(25.4*e);i=i.toFixed(5);a=a.toFixed(5);dataStr="X"+i.toString()+" Y"+a.toString()+" Z"+r.toString();return dataStr};this.generateGCode=function(r){var e="";e+="(ToDo, add information about what, how, when, and who made this file)\n\n";e+="G17 (set XY Plane)\n";e+="G20 (inches)\n";e+="G40 (Tool Radius Compensation: off)\n";e+="G49 (Tool Length Offset Compensation: off)\n";e+="G54 (Work Coordinate System)\n";e+="G80 (Cancel Canned Cycle)\n";e+="G90(absolute programming)\n";e+="G94 (feedrate per minute)\n";e+="G0 Z1.0(seek to z = 1)\n";e+="F120.0 (feedrate in inches per minute)\n";var i,a;var n=-.1;var o=.9;this.pathSimpleSegs.forEach(function(h,s){e+="G0 Z"+o.toString()+"\n";a=h[0];i=t(a,o,r);e+=i+"\n";h.forEach(function(a,o){i=t(a,n,r);e+=i+"\n"})});e+="G0 Z"+o.toString()+"\n";exportToFile(e,"partGCode.nc")};this.drawSegments=function(t){var r=t.getContext("2d");var e;for(e=0;e<this.pathSegments.length;++e){a(r,this.pathSegments[e])}};this.drawSimpleSegments=function(t){var e=t.getContext("2d");var i;var a=this.pathSimpleSegs.length;for(i=0;i<a;++i){r(e,this.pathSimpleSegs[i])}};this.drawArcSegs=function(t){var r=t.getContext("2d");var i;var a=this.pathArcSegs.length;for(i=0;i<a;++i){e(r,this.pathArcSegs[i])}};var r=function(t,r){var e,i;t.beginPath();t.moveTo(r[0].x,r[0].y);for(e=1;e<r.length-1;++e){i=r[e];t.lineTo(i.x,i.y)}t.lineTo(r[0].x,r[0].y);t.stroke()};var e=function(t,r){var e,i,a,n;var o=r.length-1;t.save();t.strokeStyle="rgb(150,0,0)";t.lineWidth=4;t.beginPath();t.moveTo(r[0].x,r[0].y);for(e=0;e<r.length-2;e+=2){i=r[e];a=r[e+1];n=r[e+2];t.arcTo(a.x,a.y,n.x,n.y,a.radius)}t.stroke()};var a=function(t,r){t.beginPath();for(i=0;i<r.length;++i){iPtDir=r[i];t.rect(iPtDir.x,iPtDir.y,1,1)}t.fill()};this.draw=function(t){var r,e;var i=t.getContext("2d");a(i,this.ptdirs)}}var initBoundryCanvas=function(){var t=$("#pixelsPerMm").val()-0;t=t||1;drawBoundaryCanvas(t)};var clearPathCanvas=function(){var t=pathcanvas.getContext("2d");t.clearRect(0,0,pathcanvas.width,pathcanvas.height)};var clearDrawingCanvas=function(){var t=document.getElementById("mycanvas");var r=t.getContext("2d");r.save();r.fillStyle="white";r.fillRect(0,0,t.width,t.height);r.restore()};var onGenGCode=function(){var t=$("#pixelsPerMm").val()-0;t=t||1;MyApp.path.generateGCode(t)};var onChangeUnits=function(t){$("#pixelsPerMm").val(t);drawBoundaryCanvas(t)};var onExportSTL=function(){};var onChangeResolution=function(t){MyApp.displayRes=t;var r=$("#hiddencanvas")[0];var e=r.getContext("2d");e.scale(t,t);drawCutouts(r,MyApp.cutouts,MyApp.layout);e.scale(1/t,1/t);var i=e.getImageData(0,0,r.width,r.height);var a=document.getElementById("mycanvas");var n=a.getContext("2d");n.scale(2/t,2/t);n.drawImage(r,0,0,a.width,a.height);n.scale(t/2,t/2)};var drawBoundaryCanvas=function(t){var r=document.getElementById("boundaryCanvas");var e=r.getContext("2d");e.clearRect(0,0,r.width,r.height);e.font="10px sans-serif";var i=100/t;i=i.toFixed(1);e.fillText(i,93,8);e.fillText("mm",120,8);e.beginPath();for(var a=0;a<r.width;a+=10){var n=a/100==parseInt(a/100)?0:10;e.moveTo(a+15,n);e.lineTo(a+15,15);var o=a/100==parseInt(a/100)?0:10;e.moveTo(o,a+15);e.lineTo(15,a+15)}e.stroke()};var emptyThe3DScene=function(){while(group.children.length>0){group.remove(group.children[group.children.length-1])}};var onGo3D=function(){var t=$("#matthkbox").val()-0;emptyThe3DScene();if(MyApp.path)MyApp.path.addSimpleSegsToScene();var r=buildZeroOffsetPath();r.addSimpleSegsAsMeshes(t);MyApp.zOffPath=r;animate()};var onExportOBJ=function(){var t=$("#matthkbox").val()-0;var r=buildZeroOffsetPath();r.addSimpleSegsAsMeshes(t);var e=meshesToObj(r.meshes);exportToFile(e,"boxmaker.obj")};var meshesToObj=function(t){var r="";var e=0;var i;for(var a=0;a<t.length;++a){i=t[a];r+=meshToObj(i,e);e+=i.children[0].geometry.vertices.length}return r};var meshToObj=function(t,r){obj=geometryToObj(t.children[0].geometry,r);return obj};var geometryToObj=function(t,r){var e="";for(i=0;i<t.vertices.length;i++){e+="v "+t.vertices[i].x+" "+t.vertices[i].y+" "+t.vertices[i].z+"\n"}for(i=0;i<t.faces.length;i++){e+="f "+(t.faces[i].a+1+r)+" "+(t.faces[i].b+1+r)+" "+(t.faces[i].c+1+r);if(t.faces[i].d!==undefined){e+=" "+(t.faces[i].d+1+r)}e+="\n"}return e};var buildZeroOffsetPath=function(){var t=$("#pixelsPerMm").val()-0;var r=document.getElementById("mycanvas");var e=document.getElementById("pathcanvas");var i=buildToolpaths3(1,r);return i};var onCalcPath=function(){var t=$("#toolbitDiam").val()-0;t=t||5;var r=$("#pixelsPerMm").val()-0;r=r||1;var e=document.getElementById("mycanvas");var i=document.getElementById("hiddencanvas");var a=document.getElementById("resolutionSlider");var n=a?a.value:1;var o=buildToolpaths3(t*r,e);clearPathCanvas();o.drawSimpleSegments(pathcanvas);MyApp.path=o};var drawtestsquare=function(t){var r=t.getContext("2d");r.moveTo(10,10);r.lineTo(99,302);r.lineTo(157,302);r.stroke()};var buildToolpaths3=function(t,r){var e=new AcGrey8Image(r.width,r.height);e.initFromCanvas(r);var i=new AcGrey16Image(r.width,r.height);computeDistTrans(e,i);var a=new Path;vectorizeDistanceTrf(i,t/2,a);a.buildSimpleSegs(1);return a};var followDirection=function(t,r,e){var i={x:e.x,y:e.y};switch(e.dir){case DirectionEnum.North:i.y--;break;case DirectionEnum.East:i.x++;break;case DirectionEnum.South:i.y++;break;case DirectionEnum.West:i.x--;break;default:console.log("followDirection: bad direction enum - file a bug")}var a=t.getEncodedNbrhd(i.x,i.y);var n=r.nbrhdToDir(a);return{x:i.x,y:i.y,dir:n}};var followPath=function(t,r,e,i){var a=new Array;r.pathSegments.push(a);var n=t;var o={x:n.x,y:n.y};a.push(n);var h=followDirection(e,i,n);n=h;while(n.dir!=DirectionEnum.Stop&&(n.x!=o.x||n.y!=o.y)){a.push(n);var h=followDirection(e,i,n);n=h}};var findFirstPointNotInPathSegs=function(t){var r,e,a,n,o,h,s;for(i=0;i<t.ptdirs.length;++i){n=t.ptdirs[i];s=false;for(a=0;a<t.pathSegments.length&&!s;++a){o=t.pathSegments[a];for(e=0;e<o.length&&!s;++e){h=o[e];if(h.x===n.x&&h.y===n.y){s=true}}}if(s===false)return n}};var vectorizeDistanceTrf=function(t,r,e){var i=new DirectionMap;var a=t.copy();var n=Math.ceil(r);var o=n*n;a.thresholdImage(o);var h,s,c,u,d,v,y,f,l,m,p,g,x,E;for(p=1;p<a.width-1;++p){for(g=1;g<a.height-1;++g){E=a.getEncodedNbrhd(p,g);x=i.nbrhdToDir(E);if(x&&x!=DirectionEnum.Stop){var D={x:p,y:g,dir:x};e.ptdirs.push(D)}}}if(e.ptdirs.length===0)return;var w=e.ptdirs[0];while(w){followPath(w,e,a,i);w=findFirstPointNotInPathSegs(e)}};