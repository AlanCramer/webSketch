<!DOCTYPE HTML>
<html>

<head>

<script src="../jquery-2.1.0.min.js"></script>
<script src="cutout.js"></script>
<script src="layoutCutoutUtil.js"></script>
<script src="DirectionMap.js"></script>
<script src="acGreyImage.js"></script>
<script src="distTrans.js"></script>
<script src="Vectorize.js"></script>
<script src="Path.js"></script>
<script src="mathUtil.js"></script>



<link rel="stylesheet" href="pathImage.css">
    
<script>


var onGenGCode = function() {

    var pixelsPerMm = $("#pixelsPerMm").val()-0;
    MyApp.path.generateGCode(pixelsPerMm);	
}

var onLoadImage = function() {

    var fileElem = $("#openimage");
    fileElem.click();
}

var onCalcPath = function() {

    var toolbitDiam = $("#toolbitDiam").val()-0;
    var pixelsPerMm = $("#pixelsPerMm").val()-0;
    var canvas = document.getElementById('mycanvas');
    var pathcanvas = document.getElementById('pathcanvas');
    var toolpaths = {}; // todo temp - 
            
    buildToolpaths3(toolpaths, toolbitDiam*pixelsPerMm, canvas, null, pathcanvas);  
}

var buildToolpaths3 = function(toolpaths, toolbitDiamInPix, incanvas, debugcanvas, pathcanvas){

    var inCanvasImage = new AcGrey8Image(incanvas.width,incanvas.height);
    inCanvasImage.initFromCanvas(incanvas); // todo, decide about js ctors

    var dt = new AcGrey16Image(incanvas.width, incanvas.height);

    computeDistTrans(inCanvasImage, dt);

    var pathctx = pathcanvas.getContext('2d');
    pathctx.clearRect(0,0,pathcanvas.width, pathcanvas.height);
    
    var path = new Path();
    vectorizeDistanceTrf(dt, toolbitDiamInPix/2, path);
    
        //var newPath = RamerDouglasPeucker(path.pathSegments[0],2);
    path.buildSimpleSegs(1);
    
    path.drawSimpleSegments(pathcanvas);    
//    path.drawSegments(incanvas);
//    path.draw(pathcanvas);
    
    MyApp = {};
    MyApp.path = path;
    //path.generateGCode();


}




var buildToolpaths2 = function(toolpaths, incanvas, canvas){

    var inCanvasImage = new AcGrey8Image(0,0);
    inCanvasImage.initFromCanvas(incanvas); // todo, decide about js ctors
    
    inCanvasImage.draw(canvas);
}

var onBoxDimChange = function() {

      

    var boxDims = {};
    boxDims.height = $("#heightbox").val()-0;
    boxDims.length = $("#lengthbox").val()-0;
    boxDims.width = $("#widthbox").val()-0;    
    boxDims.matThick = $("#matthkbox").val()-0;
    
    var fingerLength = $("#fingerLength").val()-0;
    var fingerSpacing = $("#fingerSpacing").val()-0;
    var toolbitDiam = $("#toolbitDiam").val()-0;
                    
    var pixelsPerMm = $("#pixelsPerMm").val()-0;
                    
    var cutouts = {};
    buildCutouts(cutouts, boxDims, fingerLength, fingerSpacing, toolbitDiam, pixelsPerMm);

    var layout = {};
    buildLayout(layout, boxDims, toolbitDiam, pixelsPerMm);
    
    var canvas = document.getElementById('mycanvas');
    drawCutouts(canvas, cutouts, layout);

}
</script>
    
    
<script>



$(document).ready(function() {

    // record previous unit type and respond to unit change
    var sel = $("#unittype");
    sel.data("prev",sel.val());

    // update all boxDims by changing by ratio
    sel.change(function(data){
        var jqThis = $(this);
        var unitRatio = jqThis.data("prev") / jqThis.val();        
        jqThis.data("prev",jqThis.val());
        
        var selset = $(".boxDim");
        selset.each(function() { 
            $(this).val($(this).val()*unitRatio)
        });
    });
    
    $(".boxDim").change(function() {
        onBoxDimChange();
    });
    
    function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object
        var file = files[0];
        
        var fileReadAsDataUrl = new FileReader();
        fileReadAsDataUrl.onload = (function(progEvt) {
            console.log("in data url reader");
            var imageAsDataUrl = progEvt.target.result;
            
            var img = new Image();
            img.src = progEvt.target.result;

            var canvas = document.getElementById('mycanvas');
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.drawImage(img,0,0);
            
        });
        fileReadAsDataUrl.readAsDataURL(file); 
        
    }
    
    document.getElementById('openimage').addEventListener('change', handleFileSelect, false);
    
    // call it to render everything
    onBoxDimChange();
    
/*  Need a draw function that accepts the ctx and redraws the scene to enable pan and zoom.


    function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    return {
      x: evt.clientX - rect.left,
      y: evt.clientY - rect.top
    };
    }
    var canvas = document.getElementById('mycanvas');
    //var context = canvas.getContext('2d');

    canvas.addEventListener('mousewheel', function(evt) {
        var ctx = canvas.getContext('2d');
        var delta = evt.wheelDelta ? evt.wheelDelta/480 : 0;
        if (delta)
            ctx.scale(1.1, 1.1);
        
                
    }, false);
      
      
    canvas.addEventListener('mousemove', function(evt) {
    var mousePos = getMousePos(canvas, evt);
    var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;

    var statbar = document.getElementById('statusbar');
        statbar.textContent = message;
    }, false);
*/

});    
</script>
</head>

<body>
<div id="header" >
<h1>&nbsp;CNC Box Maker</h1>
</div>

<div id="Inputs" >
<table>
<tr>
  <td>Units</td>
  <td>
    <select id="unittype">
        <option value=1 selected="selected">mm</option>
        <option value=10>cm</option>
        <option value=25.4>in</option>
    <select>
<!--     <input class="boxDim" type="text" list="unittype" >
    <datalist id="unittype" >
        <option value='mm' selected>mm</option>
        <option value='cm'>cm</option>
        <option value='in'>in</option>
    </datalist> -->
  </td>
</tr>


<tr>
  <td>Height</td>
  <td><input class="boxDim" id="heightbox" type="number" value="60" ></td>
</tr>
<tr>
  <td>Length</td>
  <td><input class="boxDim" id="lengthbox" type="number" value="80" ></td>
</tr>
<tr>
  <td>Width</td>
  <td><input class="boxDim" id="widthbox" type="number" value="80" ></td>
</tr>
<tr>
  <td>Material Thickness</td>
  <td><input class="boxDim" id="matthkbox" type="number" value="4.7625" ></td>
</tr>
<tr>
  <td>Finger Length</td>
  <td><input class="boxDim" id="fingerLength" type="number" value="20" ></td>
</tr>
<tr>
  <td>Finger Spacing</td>
  <td><input class="boxDim" id="fingerSpacing" type="number" value="20" ></td>
</tr>
<tr>
  <td>Toolbit Diam</td>
  <td><input class="toolbit" id="toolbitDiam" type="number" value="3.175" ></td>
</tr>
<tr>
  <td>Pixels per mm</td>
  <td><input class="resolution" id="pixelsPerMm" type="number" value="2" ></td>
</tr>

</table>

<button onclick=onCalcPath() >Calculate Tool Path</button>
<button onclick=onGenGCode() >Generate G-Code</button>
<button onclick=onLoadImage() >Load Image</button>
<input type="file" id="openimage" name="imagefile" style="display:none"></input>
<output id="list"></output>

</div>

<div id="content" >
    <div style="position: relative;">

        <canvas id="mycanvas" width="500" height="500" 
            style="position: absolute; left: 100; top: 0; z-index: 0;"></canvas>
        <canvas id="pathcanvas" width="500" height="500" 
            style="position: absolute; left: 100; top: 0; z-index: 1;"></canvas>
    </div>
<!--     <canvas id="debugcanvas" width="300px" height="300px" ></canvas> -->
    <!-- <canvas id="pathcanvas" width="200px" height="200px" ></canvas> -->
</div>




<div id="statusbar" >
&nbsp;&nbsp;Status Bar
</div>


</body>
</html>