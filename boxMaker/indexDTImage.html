<!DOCTYPE HTML>
<html>

<head>
<script src="../jquery-2.1.0.min.js"></script>
<script src="cutout.js"></script>
<script src="layoutCutoutUtil.js"></script>
<script src="acGreyImage.js"></script>
<script src="distTrans.js"></script>

<style>
    body {
        font: 80% arial, helvetica, sans-serif;
        margin:0;
    }

    .boxDim {
        width:50px;
    }
    
    #mycanvas {
        border:2px solid#000;
    }
    #outcanvas {
        border:2px solid#ff00ff;
    }
    #gcanvas {
        border:2px solid#00ffff;
    }
    
    #navigation {
        position: absolute;
        width: 10em;
    }
    
</style>
    
<script>

var buildToolpaths3 = function(toolpaths, incanvas, gcanvas, canvas){

    var inCanvasImage = new AcGrey8Image(incanvas.width,incanvas.height);
    inCanvasImage.initFromCanvas(incanvas); // todo, decide about js ctors
    inCanvasImage.debugPrint();
    
//    toolpaths = $.extend(true, {}, inCanvasImage); // deep copy
    //toolpaths = (JSON.parse(JSON.stringify(inCanvasImage)));
    
    toolpaths = new AcGrey8Image(incanvas.width, incanvas.height);
    //toolpaths = $.extend(toolpaths, (JSON.parse(JSON.stringify(inCanvasImage)))); // copies the buffer
//    toolpaths.initFromCanvas(inCanva
  
    computeDistTrans(inCanvasImage, toolpaths, gcanvas);
    toolpaths.debugPrint();
    toolpaths.draw(canvas);
}


var buildToolpaths2 = function(toolpaths, incanvas, canvas){

    var inCanvasImage = new AcGrey8Image(0,0);
    inCanvasImage.initFromCanvas(incanvas); // todo, decide about js ctors
    
    inCanvasImage.draw(canvas);
}

var buildToolpaths = function(toolpaths, incanvas, canvas){

    var canvasWidth  = canvas.width;
    var canvasHeight = canvas.height;
    var ctx = canvas.getContext('2d');
    var imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
    
    var inCtx = incanvas.getContext('2d');
    var inImageData = inCtx.getImageData(0,0,incanvas.width, incanvas.height);
        
    var buf = new ArrayBuffer(imageData.data.length);
    var buf8 = new Uint8ClampedArray(buf);
    var data = new Uint32Array(buf);
        
    // Determine whether Uint32 is little- or big-endian.
    data[1] = 0x0a0b0c0d;
        
    // height is 0 to 255, littleEndian is a bool
    var encodeHeight = function(height, littleEndian) {
        if (littleEndian) {
        return  (255   << 24) |    // alpha
                (value << 16) |    // blue
                (value <<  8) |    // green
                value;            // red
        } 
        else {
        return  (value << 24) |    // red
                (value << 16) |    // green
                (value <<  8) |    // blue
                 255;              // alpha
        }
    }
        
    var isLittleEndian = true;
    if (buf[4] === 0x0a && buf[5] === 0x0b && buf[6] === 0x0c &&
        buf[7] === 0x0d) {
        isLittleEndian = false;
    }

    for (var y = 0; y < canvasHeight; ++y) {
        for (var x = 0; x < canvasWidth; ++x) {
            
            var i = (y*incanvas.width +x)*4;
            var red = inImageData.data[i];
            var green = inImageData.data[i + 1];
            var blue = inImageData.data[i + 2];
            var alpha = inImageData.data[i + 3];
            
            var value = x*y&0xff;
            var enVal = encodeHeight(value, isLittleEndian);
            data[y * canvasWidth + x] = 
                (255   << 24) |    // alpha
                (blue << 16) |    // blue
                (green <<  8) |    // green
                red;        
        }
    }

    imageData.data.set(buf8);
    ctx.putImageData(imageData, 0, 0);

}

</script>
    
    
<script>

$(document).ready(function() {
    $(".boxDim").change(function() {
                
        var boxDims = {};
        boxDims.height = $("#heightbox").val()-0;
        boxDims.length = $("#lengthbox").val()-0;
        boxDims.width = $("#widthbox").val()-0;    
        boxDims.matThick = $("#matthkbox").val()-0;
        
        var fingerLength = $("#fingerLength").val()-0;
        var fingerSpacing = $("#fingerSpacing").val()-0;
        var toolbitDiam = $("#toolbitDiam").val()-0;
                        
        var cutouts = {};
        buildCutouts(cutouts, boxDims, fingerLength, fingerSpacing, toolbitDiam);

        var layout = {};
        buildLayout(layout, boxDims, toolbitDiam);
        
        var canvas = document.getElementById('mycanvas');
        drawCutouts(canvas, cutouts, layout);
        
        var toolpaths = {}; // todo temp - 

        var outcanvas = document.getElementById('outcanvas');
        var gcanvas = document.getElementById('gcanvas');
        buildToolpaths3(toolpaths, canvas, gcanvas, outcanvas);
    });
});    
</script>
</head>

<body>

<div id="header" style="background-color:#9999CC;">
<h1 style="margin-bottom:0;">Box Maker</h1>
</div>

<div id="Inputs" >
<table style="width:100px;float:left" >
<tr>
  <td>Height</td>
  <td><input class="boxDim" id="heightbox" type="number" value="50" ></td>
</tr>
<tr>
  <td>Length</td>
  <td><input class="boxDim" id="lengthbox" type="number" value="100" ></td>
</tr>
<tr>
  <td>Width</td>
  <td><input class="boxDim" id="widthbox" type="number" value="50" ></td>
</tr>
<tr>
  <td>Material Thickness</td>
  <td><input class="boxDim" id="matthkbox" type="number" value="5" ></td>
</tr>
<tr>
  <td>Finger Length</td>
  <td><input class="boxDim" id="fingerLength" type="number" value="10" ></td>
</tr>
<tr>
  <td>Finger Spacing</td>
  <td><input class="boxDim" id="fingerSpacing" type="number" value="10" ></td>
</tr>
<tr>
  <td>Toolbit Diam</td>
  <td><input class="boxDim" id="toolbitDiam" type="number" value="5" ></td>
</tr>

</table>

</div>

<div id="content" >
    <canvas id="mycanvas" width="15px" height="15px" ></canvas>
    <canvas id="gcanvas" width="15px" height="15px" ></canvas>
    <canvas id="outcanvas" width="15px" height="15px" ></canvas>
</div>


<div id="statusbar" style="background-color:#99CCCC;clear:both;text-align:center;">
    Status Bar
</div>


</body>
</html>