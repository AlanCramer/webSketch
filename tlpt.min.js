var DirectionEnum={North:"north",East:"east",South:"south",West:"west",Corner:"corner",Stop:"stop"};Object.freeze(DirectionEnum);function DirectionMap(){this.dirMap={};this.nbrhdToDir=function(encodedNbrhd){if(!encodedNbrhd)return DirectionEnum.Stop;var res=this.dirMap[encodedNbrhd];return res};this.init=function(){this.addDirMapEntry(0,1,1,1,1,1,1,1,1,DirectionEnum.North);this.addDirMapEntry(1,0,1,1,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,0,1,1,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,0,1,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,1,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,1,1,1,0,1,1,1,DirectionEnum.South);this.addDirMapEntry(1,1,0,0,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,1,0,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,1,1,1,0,1,1,1,DirectionEnum.South);this.addDirMapEntry(0,1,1,1,1,1,1,1,0,DirectionEnum.Corner);this.addDirMapEntry(0,1,1,1,1,1,1,0,1,DirectionEnum.North);this.addDirMapEntry(1,1,0,1,1,1,1,0,1,DirectionEnum.West);this.addDirMapEntry(1,0,1,1,1,1,1,1,0,DirectionEnum.South);this.addDirMapEntry(1,0,1,1,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,0,1,0,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,0,1,1,1,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,1,1,0,1,1,1,DirectionEnum.South);this.addDirMapEntry(0,1,0,1,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,1,1,1,1,1,0,DirectionEnum.South);this.addDirMapEntry(1,1,0,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,1,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(1,0,1,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,1,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(0,1,1,0,1,1,0,1,1,DirectionEnum.North);this.addDirMapEntry(0,0,1,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(1,0,0,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(0,1,0,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,1,0,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(0,0,1,1,1,0,1,1,0,DirectionEnum.South);this.addDirMapEntry(1,0,0,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(0,0,0,0,1,1,0,1,1,DirectionEnum.East);this.addDirMapEntry(2,0,0,2,1,1,2,1,1,DirectionEnum.East);this.addDirMapEntry(2,0,1,2,1,1,2,1,1,DirectionEnum.East);this.addDirMapEntry(2,1,0,2,1,1,2,1,1,DirectionEnum.East);this.addDirMapEntry(0,0,2,1,1,2,1,1,2,DirectionEnum.Stop);this.addDirMapEntry(1,0,2,1,1,2,1,1,2,DirectionEnum.Stop);this.addDirMapEntry(0,0,2,1,1,2,1,0,2,DirectionEnum.Stop);this.addDirMapEntry(0,1,2,1,1,2,1,1,2,DirectionEnum.Stop);this.addDirMapEntry(0,1,2,1,1,2,1,0,2,DirectionEnum.Stop)};this.RotDir90=function(dir){if(dir===DirectionEnum.East)return DirectionEnum.South;if(dir===DirectionEnum.South)return DirectionEnum.West;if(dir===DirectionEnum.West)return DirectionEnum.North;if(dir===DirectionEnum.North)return DirectionEnum.East;return dir};this.RotDir180=function(dir){if(dir===DirectionEnum.East)return DirectionEnum.West;if(dir===DirectionEnum.South)return DirectionEnum.North;if(dir===DirectionEnum.West)return DirectionEnum.East;if(dir===DirectionEnum.North)return DirectionEnum.South;return dir};this.RotDir270=function(dir){if(dir===DirectionEnum.East)return DirectionEnum.North;if(dir===DirectionEnum.South)return DirectionEnum.East;if(dir===DirectionEnum.West)return DirectionEnum.South;if(dir===DirectionEnum.North)return DirectionEnum.West;return dir};this.encodeNbrhdRot90=function(nw,nn,ne,ww,cc,ee,sw,ss,se){return(sw<<0)+(ww<<2)+(nw<<4)+(ss<<6)+(cc<<8)+(nn<<10)+(se<<12)+(ee<<14)+(ne<<16)};this.encodeNbrhdRot180=function(nw,nn,ne,ww,cc,ee,sw,ss,se){return(se<<0)+(ss<<2)+(sw<<4)+(ee<<6)+(cc<<8)+(ww<<10)+(ne<<12)+(nn<<14)+(nw<<16)};this.encodeNbrhdRot270=function(nw,nn,ne,ww,cc,ee,sw,ss,se){return(ne<<0)+(ee<<2)+(se<<4)+(nn<<6)+(cc<<8)+(ss<<10)+(nw<<12)+(ww<<14)+(sw<<16)};this.addDirMapEntry=function(nw,nn,ne,ww,cc,ee,sw,ss,se,dir){this.dirMap[DirectionMap.encodeNbrhd(nw,nn,ne,ww,cc,ee,sw,ss,se)]=dir;this.dirMap[this.encodeNbrhdRot90(nw,nn,ne,ww,cc,ee,sw,ss,se)]=this.RotDir90(dir);this.dirMap[this.encodeNbrhdRot180(nw,nn,ne,ww,cc,ee,sw,ss,se)]=this.RotDir180(dir);this.dirMap[this.encodeNbrhdRot270(nw,nn,ne,ww,cc,ee,sw,ss,se)]=this.RotDir270(dir)};this.init()}DirectionMap.encodeNbrhd=function(nw,nn,ne,ww,cc,ee,sw,ss,se){en1=nw<<0;en2=nn<<2;en3=ne<<4;en4=ww<<6;en5=cc<<8;en6=ee<<10;en7=sw<<12;en8=ss<<14;en9=se<<16;return en1+en2+en3+en4+en5+en6+en7+en8+en9};function Matrix2(a00,a01,a10,a11){this.vals=[[a00,a01],[a10,a11]]}Matrix2.prototype.multiplyVec=function(vec){var res={};res.x=vec.x*this.vals[0][0]+vec.y*this.vals[0][1];res.y=vec.x*this.vals[1][0]+vec.y*this.vals[1][1];return res};function AcGrey8Image(width,height){AcGreyImage.call(this,width,height);this.databuffer=new ArrayBuffer(width*height);this.data=new Uint8ClampedArray(this.databuffer)}AcGrey8Image.prototype=Object.create(AcGreyImage.prototype);AcGrey8Image.prototype.constructor=AcGreyImage;AcGrey8Image.prototype.copy=function(){var dst=new AcGrey8Image(this.width,this.height);dst.data.set(this.data);return dst};function AcGrey16Image(width,height){AcGreyImage.call(this,width,height);this.databuffer=new ArrayBuffer(width*height*2);this.data=new Uint16Array(this.databuffer)}AcGrey16Image.prototype=Object.create(AcGreyImage.prototype);AcGrey16Image.prototype.constructor=AcGreyImage;AcGrey16Image.prototype.copy=function(){var dst=new AcGrey16Image(this.width,this.height);dst.data.set(this.data);return dst};function AcGreyImage(width,height){this.width=width;this.height=height}AcGreyImage.prototype.getAt=function(x,y){return this.data[this.width*y+x]};AcGreyImage.prototype.setAt=function(x,y,val){this.data[this.width*y+x]=val};AcGreyImage.prototype.copy=function(dst){throw new Error("not implemented - needs to be overridden in subclass")};AcGreyImage.prototype.getNbrhd=function(x,y){var ret={};if(x>0&&y>0&&x<this.width-1&&y<this.height-1){ret.nw=this.getAt(x-1,y-1);ret.nn=this.getAt(x,y-1);ret.ne=this.getAt(x+1,y-1);ret.ww=this.getAt(x-1,y);ret.cc=this.getAt(x,y);ret.ee=this.getAt(x+1,y);ret.sw=this.getAt(x-1,y+1);ret.ss=this.getAt(x,y+1);ret.se=this.getAt(x+1,y+1)}return ret};AcGreyImage.prototype.getEncodedNbrhd=function(x,y){var ret=this.getNbrhd(x,y);return DirectionMap.encodeNbrhd(ret.nw,ret.nn,ret.ne,ret.ww,ret.cc,ret.ee,ret.sw,ret.ss,ret.se)};AcGreyImage.prototype.insertBoundary=function(){var i,j;var maxj=this.height-1;var maxi=this.width-1;for(i=0;i<this.width;++i){this.setAt(i,0,2);this.setAt(i,maxj,2)}for(j=0;j<this.height;++j){this.setAt(0,j,2);this.setAt(maxi,j,2)}};AcGreyImage.prototype.invertImage=function(){var i,j;for(i=0;i<this.width;++i){for(j=0;j<this.height;++j){this.setAt(i,j,this.getAt(i,j)===0?1:0)}}};AcGreyImage.prototype.thresholdImage=function(value){var i,j;for(i=0;i<this.width;++i){for(j=0;j<this.height;++j){this.setAt(i,j,this.getAt(i,j)<=value?1:0)}}};AcGreyImage.prototype.debugPrint=function(){console.log("Width, Height: "+this.width+", "+this.height);var msg="";var pad="000";for(var y=0;y<this.height;++y){for(var x=0;x<this.width;++x){var value=this.getAt(x,y);var result=(pad+value.toString()).slice(-pad.length);msg=msg+result+" "}msg=msg+"\n"}console.log(msg)};AcGreyImage.prototype.initFromCanvas=function(canvas){var ctx=canvas.getContext("2d");this.width=canvas.width;this.height=canvas.height;var imageData=ctx.getImageData(0,0,this.width,this.height);var buf=imageData.data;var buf8=new Uint8ClampedArray(imageData.data);var data=new Uint32Array(imageData.data);this.databuffer=new ArrayBuffer(imageData.data.length/4);this.data=new Uint8ClampedArray(this.databuffer);data[1]=168496141;var isLittleEndian=true;if(buf[4]===10&&buf[5]===11&&buf[6]===12&&buf[7]===13){isLittleEndian=false}for(var y=0;y<this.height;++y){for(var x=0;x<this.width;++x){var i=(y*canvas.width+x)*4;var red=isLittleEndian?data[i]:data[i+3];var green=isLittleEndian?data[i+1]:data[i+2];var blue=isLittleEndian?data[i+2]:data[i+1];var alpha=isLittleEndian?data[i+3]:data[i];var val=.2126*red+.7152*green+.0722*blue;if(alpha===0)val=1;this.data[y*this.width+x]=val}}};AcGreyImage.prototype.draw=function(canvas,xPos,yPos){var canvasWidth=canvas.width;var canvasHeight=canvas.height;var ctx=canvas.getContext("2d");var imageData=ctx.getImageData(0,0,canvasWidth,canvasHeight);var buf=new ArrayBuffer(imageData.data.length);var buf8=new Uint8ClampedArray(buf);var data=new Uint32Array(buf);data[1]=168496141;var isLittleEndian=true;if(buf[4]===10&&buf[5]===11&&buf[6]===12&&buf[7]===13){isLittleEndian=false}for(var y=0;y<this.height;++y){for(var x=0;x<this.width;++x){var value=this.getAt(x,y);data[y*canvasWidth+x]=this.encodeHeight(value,isLittleEndian)}}imageData.data.set(buf8);ctx.putImageData(imageData,0,0)};AcGreyImage.prototype.convolve3x3=function(img,fn){for(var y=1;y<this.height;++y){for(var x=1;x<this.width;++x){var nbr=img.getNbrhd(x,y);var val=fn(nbr);this.setAt(x,y,val)}}};AcGrey8Image.prototype.encodeHeight=function(value,littleEndian){if(littleEndian){return 255<<24|value<<16|value<<8|value}else{return value<<24|value<<16|value<<8|255}};AcGrey16Image.prototype.encodeHeight=function(value,littleEndian){if(littleEndian){if(value>2550)value=2550;return 255<<24|value/10<<16|value/10<<8|value/10}else{return value/255<<24|value/255<<16|value/255<<8|255}};circToPtsErr=function(ptArr,circle){var maxErr=0;for(var i=0;i<ptArr.length;++i){var curErr=distPtCirc(ptArr[i],circle);if(curErr>maxErr)maxErr=curErr}return maxErr};reduceInterval=function(ptArr,mmin,ma,mb,mmax){var ret={min:mmin,max:mmax};var circ_ma=makeCircleBy3Pts(ptArr[0],{x:0,y:ma},ptArr[ptArr.length-1]);var circ_mb=makeCircleBy3Pts(ptArr[0],{x:0,y:mb},ptArr[ptArr.length-1]);var err_a=circToPtsErr(ptArr,circ_ma);var err_b=circToPtsErr(ptArr,circ_mb);var tol=1e-4;if(Math.abs(err_a-err_b)<tol){ret.min=ma;ret.max=mb;return ret}if(err_a<err_b){ret.max=mb;return ret}if(err_a>err_b){ret.min=ma;return ret}};findMminMmax=function(ptArr){if(ptArr.length<3)alert("less than 3 pts in findMminMmax");var last=ptArr.length-1;var st=ptArr[0];var en=ptArr[last];var mmin,mi,mmax;var circ;var allCollinear=true;var perp=makePerpBisectLine(st,en);mmin=Number.MAX_VALUE;mmax=Number.MIN_VALUE;for(var i=1;i<last;++i){if(collinear(st,ptArr[i],en))continue;allCollinear=false;circ=makeCircleBy3Pts(st,ptArr[i],en);mi=circ.center.y+circ.radius;if(mi<mmin)mmin=mi;if(mi>mmax)mmax=mi}if(allCollinear){alert("all collinear?");mmin=mmax=0}return{min:mmin,max:mmax}};_findBestArcYVal=function(ptArr,epsilon){var intvl=findMminMmax(ptArr);var ma,mb;var d=intvl.max-intvl.min;while(d>epsilon){ma=d/3+intvl.min;mb=2*d/3+intvl.min;intvl=reduceInterval(ptArr,intvl.min,ma,mb,intvl.max);d=intvl.max-intvl.min}var mbar=(intvl.max+intvl.min)/2;return mbar};findBestCircleFit=function(pts,epsilon){var trfPts=pts.slice(0);var pt0=pts[0];var end=pts.length-1;var ptn=pts[end];var dy=ptn.y-pt0.y;var dx=ptn.x-pt0.x;var dist=distPtPt(pt0,ptn);var dyu=dy/dist;var dxu=dx/dist;var rot=new Matrix2(dxu,dyu,-dyu,dxu);var rotinv=new Matrix2(dxu,-dyu,dyu,dxu);for(var iPt=0;iPt<pts.length;++iPt){trfPts[iPt]=rot.multiplyVec(pts[iPt])}var midpt=makeMidPt(trfPts[0],trfPts[end]);for(var iPt=0;iPt<pts.length;++iPt){trfPts[iPt].x=trfPts[iPt].x-midpt.x;trfPts[iPt].y=trfPts[iPt].y-midpt.y}var arcY=_findBestArcYVal(trfPts,epsilon);var circ=makeCircleBy3Pts(trfPts[0],{x:0,y:arcY},trfPts[end]);circ.center.x=circ.center.x+midpt.x;circ.center.y=circ.center.y+midpt.y;var arcmid={x:0+midpt.x,y:arcY+midpt.y};circ.center=rotinv.multiplyVec(circ.center);arcmid=rotinv.multiplyVec(arcmid);return{circle:circ,arcpts:[pts[0],arcmid,pts[end]]}};function Sep(G,y,i,u){"use strict";return Math.floor((u*u-i*i+G.getAt(u,y)*G.getAt(u,y)-G.getAt(i,y)*G.getAt(i,y))/(2*(u-i)))}function EDT_f(G,y,x,i){"use strict";return(x-i)*(x-i)+G.getAt(i,y)*G.getAt(i,y)}function computeDistTrans(inGreyImg,dt){"use strict";var g,m,n,maxGVal,i,j,q,s,t,u,w;g=new AcGrey16Image(inGreyImg.width,inGreyImg.height);m=inGreyImg.width;n=inGreyImg.height;maxGVal=m+n;for(i=0;i<m;i+=1){g.data[i]=inGreyImg.getAt(i,0)===0?0:maxGVal;for(j=1;j<n;j+=1){g.data[j*g.width+i]=inGreyImg.getAt(i,j)===0?0:1+g.getAt(i,j-1)}for(j=n-1;j>=0;j-=1){if(g.getAt(i,j+1)<g.getAt(i,j)){g.data[j*g.width+i]=1+g.getAt(i,j+1)}}}for(j=0;j<n;++j){q=0;s=[];t=[];s[0]=0;t[0]=0;for(u=1;u<m;++u){while(q>=0&&EDT_f(g,j,t[q],s[q])>EDT_f(g,j,t[q],u)){--q}if(q<0){q=0;s[0]=u}else{w=1+Sep(g,j,s[q],u);if(w<m){++q;s[q]=u;t[q]=w}}}for(u=m;u>=0;--u){dt.data[j*dt.width+u]=EDT_f(g,j,u,s[q]);if(u===t[q]){--q}}}}var drawCutouts=function(canvas,cutouts,layout){var ctx=canvas.getContext("2d");ctx.save();ctx.fillStyle="white";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.restore();ctx.save();ctx.fillStyle="#000000";cutouts.bottom.draw(canvas,layout.bottom.x,layout.bottom.y);cutouts.front.draw(canvas,layout.front.x,layout.front.y);cutouts.back.draw(canvas,layout.back.x,layout.back.y);cutouts.left.draw(canvas,layout.left.x,layout.left.y);cutouts.right.draw(canvas,layout.right.x,layout.right.y);ctx.restore()};var buildCutouts=function(cutouts,boxDims,fingerLength,fingerSpacing,toolbitDiam,pixPerMm){cutouts.bottom=new Cutout(boxDims.length,boxDims.width,boxDims.matThick,null,fingerLength,fingerSpacing,toolbitDiam,pixPerMm);cutouts.front=new Cutout(boxDims.length,boxDims.height,boxDims.matThick,true,fingerLength,fingerSpacing,toolbitDiam,pixPerMm);cutouts.back=new Cutout(boxDims.length,boxDims.height,boxDims.matThick,true,fingerLength,fingerSpacing,toolbitDiam,pixPerMm);cutouts.left=new Cutout(boxDims.height,boxDims.width,boxDims.matThick,false,fingerLength,fingerSpacing,toolbitDiam,pixPerMm);cutouts.right=new Cutout(boxDims.height,boxDims.width,boxDims.matThick,false,fingerLength,fingerSpacing,toolbitDiam,pixPerMm)};var buildLayout=function(layout,boxDims,toolbitDiam,pixelsPerMm){var margin=30;var spacing=toolbitDiam*1.1*pixelsPerMm;var height=boxDims.height*pixelsPerMm;var width=boxDims.width*pixelsPerMm;var length=boxDims.length*pixelsPerMm;layout.bottom={};layout.bottom.x=height+3*spacing+margin;layout.bottom.y=height+3*spacing+margin;layout.front={};layout.front.x=spacing+margin;layout.front.y=height+3*spacing+margin;layout.back={};layout.back.x=height+width+5*spacing+margin;layout.back.y=height+3*spacing+margin;layout.left={};layout.left.x=height+3*spacing+margin;layout.left.y=spacing+margin;layout.right={};layout.right.x=height+3*spacing+margin;layout.right.y=height+length+5*spacing+margin};var distPtPt=function(p0,p1){return Math.sqrt((p1.x-p0.x)*(p1.x-p0.x)+(p1.y-p0.y)*(p1.y-p0.y))};var distPointLineseg=function(pt,lineseg){var line=makeLineBy2Pts(lineseg.p0,lineseg.p1);var dline=distPointLine(pt,line);var dp0=distPtPt(pt,lineseg.p0);var dp1=distPtPt(pt,lineseg.p1);return Math.min(dline,dp0,dp1)};var distPointLine=function(pt,line){var numer=Math.abs(line.a*pt.x+line.b*pt.y+line.c);var denom=Math.sqrt(line.a*line.a+line.b*line.b);var res=numer/denom;return res};var makeLineBy2Pts=function(pt0,pt1){var a=pt0.y-pt1.y;var b=pt1.x-pt0.x;var c=pt0.x*pt1.y-pt1.x*pt0.y;return{a:a,b:b,c:c}};var makeMidPt=function(p0,p1){return{x:(p0.x+p1.x)/2,y:(p0.y+p1.y)/2}};var collinear=function(p0,p1,p2,tol){if(!tol)tol=.001;var v0={};var v1={};v0.x=p1.x-p0.x;v0.y=p1.y-p0.y;v1.x=p2.x-p0.x;v1.y=p2.y-p0.y;var det=v0.x*v1.y-v1.x*v0.y;return Math.abs(det)<tol};var makePerpBisectLine=function(p0,p1){var bisectPt=makeMidPt(p0,p1);var otherPt={x:bisectPt.y+bisectPt.x-p1.y,y:p1.x+bisectPt.y-bisectPt.x};return makeLineBy2Pts(bisectPt,otherPt)};var makeCircleBy3Pts=function(a,b,c){var tmp=2*(a.x*(b.y-c.y)+b.x*(c.y-a.y)+c.x*(a.y-b.y));var cx=((a.x*a.x+a.y*a.y)*(b.y-c.y)+(b.x*b.x+b.y*b.y)*(c.y-a.y)+(c.x*c.x+c.y*c.y)*(a.y-b.y))/tmp;var cy=((a.x*a.x+a.y*a.y)*(c.x-b.x)+(b.x*b.x+b.y*b.y)*(a.x-c.x)+(c.x*c.x+c.y*c.y)*(b.x-a.x))/tmp;var lenABsq=(b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y);var lenBCsq=(b.x-c.x)*(b.x-c.x)+(b.y-c.y)*(b.y-c.y);var lenCAsq=(c.x-a.x)*(c.x-a.x)+(c.y-a.y)*(c.y-a.y);var diamNum=2*Math.sqrt(lenABsq*lenBCsq*lenCAsq);var lenAB=Math.sqrt(lenABsq);var lenBC=Math.sqrt(lenBCsq);var lenCA=Math.sqrt(lenCAsq);var diamDenomSq=(lenAB+lenBC+lenCA)*(-lenAB+lenBC+lenCA)*(lenAB-lenBC+lenCA)*(lenAB+lenBC-lenCA);var diamDenom=Math.sqrt(diamDenomSq);var diam=diamNum/diamDenom;return{center:{x:cx,y:cy},radius:diam/2}};var distPtCirc=function(pt,cir){var cc=cir.center;var dsq=(pt.x-cc.x)*(pt.x-cc.x)+(pt.y-cc.y)*(pt.y-cc.y);var d=Math.sqrt(dsq);return Math.abs(d-cir.radius)};var intersectLineCircle=function(p0,p1,c){var tol=1e-6;if(distPtPt(p0,p1)<tol||c.radius<tol){return false}var cx=c.center.x;var cy=c.center.y;var cr=c.radius;var a=Math.pow(p1.x-p0.x,2)+Math.pow(p1.y-p0.y,2);var b=2*(p1.x-p0.x)*(p0.x-cx)+2*(p1.y-p0.y)*(p0.y-cy);var c=Math.pow(p0.x-cx,2)+Math.pow(p0.y-cy,2)-Math.pow(cr,2);var bb4ac=b*b-4*a*c;if(bb4ac<0){return false}var d=Math.sqrt(bb4ac);var t0=(-b+d)/(2*a);var t1=(-b-d)/(2*a);var xt0=(p1.x-p0.x)*t0+p0.x;var yt0=(p1.y-p0.y)*t0+p0.y;var xt1=(p1.x-p0.x)*t1+p0.x;var yt1=(p1.y-p0.y)*t1+p0.y;return[{x:xt0,y:yt0},{x:xt1,y:yt1}]};var DouglasPeuckerCircs=function(pointList,epsilon){if(pointList.length<3)return[];var dmax=0;var index=0;var dC=0;var dCmax=0;var iC=0;var iRad=0;var circInfo=findBestCircleFit(pointList,epsilon);var circ=circInfo.circle;var end=pointList.length-1;var resultList=[];for(var i=0;i<=end;++i){var d=distPtCirc(pointList[i],circ);if(d>dmax){index=i;dmax=d}}if(dmax>epsilon){var recResults1=DouglasPeuckerCircs(pointList.slice(0,index),epsilon);var recResults2=DouglasPeuckerCircs(pointList.slice(index,end),epsilon);resultList=recResults1;resultList=resultList.concat(recResults2)}else{resultList.push(pointList[0]);resultList.push({x:circInfo.arcpts[1].x,y:circInfo.arcpts[1].y,cx:circInfo.circle.center.x,cy:circInfo.circle.center.y,radius:circInfo.circle.radius})}return resultList};var RamerDouglasPeucker=function(pointList,epsilon){var dmax=0;var index=0;var dC=0;var dCmax=0;var iC=0;var iRad=0;var end=pointList.length-1;var resultList=[];for(var i=0;i<=end;++i){var d=distPointLineseg(pointList[i],{p0:pointList[0],p1:pointList[end]});if(d>dmax){index=i;dmax=d}}if(dmax>epsilon){var recResults1=RamerDouglasPeucker(pointList.slice(0,index),epsilon);var recResults2=RamerDouglasPeucker(pointList.slice(index,end),epsilon);resultList=recResults1;resultList=resultList.concat(recResults2)}else{resultList.push(pointList[0]);resultList.push(pointList[end])}return resultList};HA_PathUtil={};HA_PathUtil.gCodePaths=function(paths,pxPerMm){var gCode="";var ceiling=1;var cutHeight=-.1;var feedrateInPerMin=120;gCode+=this.gCodeSetUp(feedrateInPerMin);for(var iPath=0;iPath<paths.length;++iPath){var path=paths[iPath];gCode+=path.gCodeForSegs(path.pathSimpleSegs,ceiling,cutHeight,pxPerMm)}gCode+=this.gCodeTakeDown(ceiling);return gCode};HA_PathUtil.gCodeJogPoints=function(jogHeight,cutDepth,pt,pxPerMm){var gCode="";gCode+="G0 Z"+jogHeight.toString()+"\n";gCode+=getGCodeMoveTo(pt,jogHeight,pxPerMm);gCode+="G0 Z"+cutDepth.toString()+"\n";return gCode};HA_PathUtil.gCodeTakeDown=function(finalHeight){var gCode="";gCode+="G0 Z"+finalHeight.toString()+"\n";return gCode};HA_PathUtil.gCodeSetUp=function(feedrateInPerMin){var gCode="";gCode+="(ToDo, add information about what, how, when, and who made this file)\n\n";gCode+="G17 (set XY Plane)\n";gCode+="G20 (inches)\n";gCode+="G40 (Tool Radius Compensation: off)\n";gCode+="G49 (Tool Length Offset Compensation: off)\n";gCode+="G54 (Work Coordinate System)\n";gCode+="G80 (Cancel Canned Cycle)\n";gCode+="G90(absolute programming)\n";gCode+="G94 (feedrate per minute)\n";gCode+="F"+feedrateInPerMin+" (feedrate in inches per minute)\n";return gCode};function Path(){this.ptdirs=[];this.pathSegments=[];this.pathSimpleSegs=[];this.pathArcSegs=[];this.meshes=[];this.scaleSimpleSegs=function(scale){for(var i=0;i<this.pathSimpleSegs.length;++i){var curSeg=this.pathSimpleSegs[i];for(var j=0;j<curSeg.length;++j){curSeg[j].x*=scale;curSeg[j].y*=scale}}};this.buildThreeShape=function(pathSeg){var theShape=new THREE.Shape;var firstPt=pathSeg[0];var lastPt=pathSeg[pathSeg.length-1];var i;theShape.moveTo(firstPt.x,firstPt.y);for(i=1;i<pathSeg.length;++i){theShape.lineTo(pathSeg[i].x,pathSeg[i].y)}theShape.lineTo(lastPt.x,lastPt.y);return theShape};this.addSimpleSegsAsMeshes=function(matThick){var i;for(i=0;i<this.pathSimpleSegs.length;++i){var nextShape=this.buildThreeShape(this.pathSimpleSegs[i]);var extrudeSettings={amount:matThick};extrudeSettings.bevelEnabled=false;extrudeSettings.steps=1;var mesh=addShape(nextShape,extrudeSettings,12555117,-150,300,0,Math.PI,0,0,1);this.meshes.push(mesh)}};this.addSimpleSegsToScene=function(){var i;for(i=0;i<this.pathSimpleSegs.length;++i){var nextShape=this.buildThreeShape(this.pathSimpleSegs[i]);addLine(nextShape,0,-150,300,0,Math.PI,0,0,1)}};this.buildSimpleSegs=function(err){var i,simpSeg;for(i=0;i<this.pathSegments.length;++i){simpSeg=RamerDouglasPeucker(this.pathSegments[i],err);this.pathSimpleSegs.push(simpSeg)}};this.buildArcInterp=function(err){var i,simpArc;for(i=0;i<this.pathSegments.length;++i){simpArc=DouglasPeuckerCircs(this.pathSegments[i],err);this.pathArcSegs.push(simpArc)}};getGCodeMoveTo=function(pt,zVal,pixelsPerMm){var conX=pt.x/(25.4*pixelsPerMm);var conY=pt.y/(25.4*pixelsPerMm);conX=conX.toFixed(5);conY=conY.toFixed(5);dataStr="X"+conX.toString()+" Y"+conY.toString()+" Z"+zVal.toString();return dataStr};this.gcodeForSegment=function(pathSegment,jogHeight,cutHeight,pxPerMm){var gCode="";gCode+="G0 Z"+jogHeight.toString()+"\n";var jog=pathSegment[0];dataStr=getGCodeMoveTo(jog,jogHeight,pxPerMm);gCode+=dataStr+"\n";pathSegment.forEach(function(ptDir,iPtDir){dataStr=getGCodeMoveTo(ptDir,cutHeight,pxPerMm);gCode+=dataStr+"\n"});return gCode};this.gCodeForSegs=function(pathSegs,jogHeight,cutHeight,pxPerMm){var gCode="";for(var iSeg=0;iSeg<pathSegs.length;++iSeg){pathSeg=pathSegs[iSeg];gCode+=this.gcodeForSegment(pathSeg,jogHeight,cutHeight,pxPerMm)}return gCode};this.generateGCode=function(pxPerMm,useSimplifiedSegs){useSimplifiedSegs=typeof useSimplifiedSegs==="undefined";var feedrateInPerMin=120;var gCode="";gCode+=HA_PathUtil.gCodeSetUp(feedrateInPerMin);var dataStr,jogSt,pathSeg,iSeg;var cutHeight=-.1;var jogHeight=.9;var segs=useSimplifiedSegs?this.pathSimpleSegs:this.pathSegments;gCode+=this.gCodeForSegs(segs,jogHeight,cutHeight,pxPerMm);gCode+=HA_PathUtil.gCodeTakeDown(jogHeight);return gCode};this.drawSegments=function(canvas){var ctx=canvas.getContext("2d");var i;for(i=0;i<this.pathSegments.length;++i){drawPtDirs(ctx,this.pathSegments[i])}};this.drawSimpleSegments=function(canvas){var ctx=canvas.getContext("2d");var i;var end=this.pathSimpleSegs.length;for(i=0;i<end;++i){drawPtDirsWithLines(ctx,this.pathSimpleSegs[i])}};this.drawArcSegs=function(canvas){var ctx=canvas.getContext("2d");var i;var end=this.pathArcSegs.length;for(i=0;i<end;++i){drawPtsWithArcs(ctx,this.pathArcSegs[i])}};var drawPtDirsWithLines=function(ctx,ptdirs){var i,iPtDir;ctx.beginPath();ctx.moveTo(ptdirs[0].x,ptdirs[0].y);for(i=1;i<ptdirs.length-1;++i){iPtDir=ptdirs[i];ctx.lineTo(iPtDir.x,iPtDir.y)}ctx.lineTo(ptdirs[0].x,ptdirs[0].y);ctx.stroke()};var drawPtsWithArcs=function(ctx,pts){var i,ipt,ipt1,ipt2;var end=pts.length-1;ctx.save();ctx.strokeStyle="rgb(150,0,0)";ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);for(i=0;i<pts.length-2;i+=2){ipt=pts[i];ipt1=pts[i+1];ipt2=pts[i+2];ctx.arcTo(ipt1.x,ipt1.y,ipt2.x,ipt2.y,ipt1.radius)}ctx.stroke()};var drawPtDirs=function(ctx,ptdirs){ctx.beginPath();for(i=0;i<ptdirs.length;++i){iPtDir=ptdirs[i];ctx.rect(iPtDir.x,iPtDir.y,1,1)}ctx.fill()};this.draw=function(canvas){var i,iPtDir;var ctx=canvas.getContext("2d");drawPtDirs(ctx,this.ptdirs)}}var initBoundryCanvas=function(){var pixelsPerMm=$("#pixelsPerMm").val()-0;pixelsPerMm=pixelsPerMm||1;drawBoundaryCanvas(pixelsPerMm)};var clearPathCanvas=function(){var pathctx=pathcanvas.getContext("2d");pathctx.clearRect(0,0,pathcanvas.width,pathcanvas.height)};var clearDrawingCanvas=function(){var dwgcan=document.getElementById("mycanvas");var ctx=dwgcan.getContext("2d");ctx.save();ctx.fillStyle="white";ctx.fillRect(0,0,dwgcan.width,dwgcan.height);ctx.restore()};var onGenGCode=function(){var pixelsPerMm=$("#pixelsPerMm").val()-0;pixelsPerMm=pixelsPerMm||1;var gcode=MyApp.path.generateGCode(pixelsPerMm);exportToFile(gcode,"partGCode.nc")};var onChangeUnits=function(value){$("#pixelsPerMm").val(value);drawBoundaryCanvas(value)};var onExportSTL=function(){};var onChangeResolution=function(value){MyApp.displayRes=value;var hidCan=$("#hiddencanvas")[0];var hidCtx=hidCan.getContext("2d");hidCtx.scale(value,value);drawCutouts(hidCan,MyApp.cutouts,MyApp.layout);hidCtx.scale(1/value,1/value);var imageData=hidCtx.getImageData(0,0,hidCan.width,hidCan.height);var canvas=document.getElementById("mycanvas");var ctx=canvas.getContext("2d");ctx.scale(2/value,2/value);ctx.drawImage(hidCan,0,0,canvas.width,canvas.height);ctx.scale(value/2,value/2)};var drawBoundaryCanvas=function(pixelsPerMm){var canvas=document.getElementById("boundaryCanvas");var ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);ctx.font="10px sans-serif";var pixVal=100/pixelsPerMm;pixVal=pixVal.toFixed(1);ctx.fillText(pixVal,93,8);ctx.fillText("mm",120,8);ctx.beginPath();for(var i=0;i<canvas.width;i+=10){var y=i/100==parseInt(i/100)?0:10;ctx.moveTo(i+15,y);ctx.lineTo(i+15,15);var x=i/100==parseInt(i/100)?0:10;ctx.moveTo(x,i+15);ctx.lineTo(15,i+15)}ctx.stroke()};var emptyThe3DScene=function(){while(group.children.length>0){group.remove(group.children[group.children.length-1])}};var onGo3D=function(){var matThick=$("#matthkbox").val()-0;emptyThe3DScene();if(MyApp.path)MyApp.path.addSimpleSegsToScene();var path=buildZeroOffsetPath();path.addSimpleSegsAsMeshes(matThick);MyApp.zOffPath=path;animate()};var onExportOBJ=function(){var matThick=$("#matthkbox").val()-0;var path=buildZeroOffsetPath();path.addSimpleSegsAsMeshes(matThick);var obj=meshesToObj(path.meshes);exportToFile(obj,"boxmaker.obj")};var meshesToObj=function(meshes){var obj="";var vtxCt=0;var mesh;for(var imesh=0;imesh<meshes.length;++imesh){mesh=meshes[imesh];obj+=meshToObj(mesh,vtxCt);vtxCt+=mesh.children[0].geometry.vertices.length}return obj};var meshToObj=function(mesh,vertexOffset){obj=geometryToObj(mesh.children[0].geometry,vertexOffset);return obj};var geometryToObj=function(geometry,vertexOffset){var s="";for(i=0;i<geometry.vertices.length;i++){s+="v "+geometry.vertices[i].x+" "+geometry.vertices[i].y+" "+geometry.vertices[i].z+"\n"}for(i=0;i<geometry.faces.length;i++){s+="f "+(geometry.faces[i].a+1+vertexOffset)+" "+(geometry.faces[i].b+1+vertexOffset)+" "+(geometry.faces[i].c+1+vertexOffset);if(geometry.faces[i].d!==undefined){s+=" "+(geometry.faces[i].d+1+vertexOffset)}s+="\n"}return s};var buildZeroOffsetPath=function(){var pixelsPerMm=$("#pixelsPerMm").val()-0;var canvas=document.getElementById("mycanvas");var pathcanvas=document.getElementById("pathcanvas");var path=buildToolpaths3(1,canvas);return path};var onCalcPath=function(){var toolbitDiam=$("#toolbitDiam").val()-0;toolbitDiam=toolbitDiam||5;var pixelsPerMm=$("#pixelsPerMm").val()-0;pixelsPerMm=pixelsPerMm||1;var canvas=document.getElementById("mycanvas");var hidcanvas=document.getElementById("hiddencanvas");var res=document.getElementById("resolutionSlider");var resVal=res?res.value:1;var path=buildToolpaths3(toolbitDiam*pixelsPerMm,canvas);clearPathCanvas();path.drawSimpleSegments(pathcanvas);MyApp.path=path};var drawtestsquare=function(canvas){var ctx=canvas.getContext("2d");ctx.moveTo(10,10);ctx.lineTo(99,302);ctx.lineTo(157,302);ctx.stroke()};var buildPocketToolpaths=function(incanvas,bitDiamPx){var inCanvasImage=new AcGrey8Image(incanvas.width,incanvas.height);inCanvasImage.initFromCanvas(incanvas);inCanvasImage.invertImage();return buildPocketToolpathsFromImage(inCanvasImage,bitDiamPx)};var buildPocketToolpathsFromImage=function(img,bitDiamPx){var dt=new AcGrey16Image(img.width,img.height);computeDistTrans(img,dt);var paths=[];var path;var done=false;var pathCt=1;while(!done){path=new Path;vectorizeDistanceTrf(dt,pathCt*bitDiamPx/2,path);path.buildSimpleSegs(.5);done=path.pathSegments.length===0;if(!done){paths.push(path);++pathCt}}return paths};var buildToolpaths3=function(toolbitDiamInPx,incanvas){var inCanvasImage=new AcGrey8Image(incanvas.width,incanvas.height);inCanvasImage.initFromCanvas(incanvas);var dt=new AcGrey16Image(incanvas.width,incanvas.height);computeDistTrans(inCanvasImage,dt);var path=new Path;vectorizeDistanceTrf(dt,toolbitDiamInPx/2,path);path.buildSimpleSegs(1);return path};var buildRoughPass=function(geomCanvas,bitDiamPx,stepDepth){var geomImage=new AcGrey8Image(geomCanvas.width,geomCanvas.height);geomImage.initFromCanvas(geomCanvas);var curImage;var allpaths=[];var curDepth=stepDepth;while(curDepth<=1){var curImage=geomImage.copy();curImage.thresholdImage(curDepth*255);paths=buildPocketToolpathsFromImage(curImage,bitDiamPx);allpaths.push(paths);curDepth=curDepth+stepDepth}return allpaths};var followDirection=function(thresh,dirMap,pt){var pos={x:pt.x,y:pt.y};switch(pt.dir){case DirectionEnum.North:pos.y--;break;case DirectionEnum.East:pos.x++;break;case DirectionEnum.South:pos.y++;break;case DirectionEnum.West:pos.x--;break;default:console.log("followDirection: bad direction enum - file a bug")}var nbrhd=thresh.getEncodedNbrhd(pos.x,pos.y);var nextDir=dirMap.nbrhdToDir(nbrhd);return{x:pos.x,y:pos.y,dir:nextDir}};var followPath=function(ptOnPath,outpath,thresh,dirMap){var pathSeg=new Array;outpath.pathSegments.push(pathSeg);var pt=ptOnPath;var pathStart={x:pt.x,y:pt.y};pathSeg.push(pt);var next=followDirection(thresh,dirMap,pt);pt=next;while(pt.dir!=DirectionEnum.Stop&&(pt.x!=pathStart.x||pt.y!=pathStart.y)){pathSeg.push(pt);var next=followDirection(thresh,dirMap,pt);pt=next}};var findFirstPointNotInPathSegs=function(outpath){var iPt,jPt,iSeg,curPt,curSeg,curSegPt,found;for(i=0;i<outpath.ptdirs.length;++i){curPt=outpath.ptdirs[i];found=false;for(iSeg=0;iSeg<outpath.pathSegments.length&&!found;++iSeg){curSeg=outpath.pathSegments[iSeg];for(jPt=0;jPt<curSeg.length&&!found;++jPt){curSegPt=curSeg[jPt];if(curSegPt.x===curPt.x&&curSegPt.y===curPt.y){found=true}}}if(found===false)return curPt}};var vectorizeDistanceTrf=function(dt,dist,outpath){var dirMap=new DirectionMap;var thresh=dt.copy();var roundUp=Math.ceil(dist);var safeDist=roundUp*roundUp;thresh.thresholdImage(safeDist);thresh.insertBoundary();var nw,nn,ne,ee,cc,ww,sw,ss,se,ennb,i,j,dir,nbrhd;for(i=1;i<thresh.width-1;++i){for(j=1;j<thresh.height-1;++j){nbrhd=thresh.getEncodedNbrhd(i,j);dir=dirMap.nbrhdToDir(nbrhd);if(dir&&dir!=DirectionEnum.Stop){var ptdir={x:i,y:j,dir:dir};outpath.ptdirs.push(ptdir)}}}if(outpath.ptdirs.length===0)return;var pt=outpath.ptdirs[0];while(pt){followPath(pt,outpath,thresh,dirMap);pt=findFirstPointNotInPathSegs(outpath)}};